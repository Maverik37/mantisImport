<script>
  const lotsData = {{ lots_json|safe }};

  var table = new Tabulator("#example-table", {
      data: lotsData,
      columns: [
          {title: "Lot", field: "Name"},
          {
              title: "Version",
              field: "Select",
              editor: "select",
              editorParams: function(cell){
                  // prend les valeurs de la clé "Select" dans ton JSON
                  let rowData = cell.getRow().getData();
                  let options = {};
                  rowData.Select.forEach(opt => {
                      options[opt.version] = opt.version;
                  });
                  return { values: options };
              },
              formatter: function(cell){
                  let rowData = cell.getRow().getData();
                  let selected = rowData.Select.find(opt => opt.selected);
                  return selected ? selected.version : "Sélection la version";
              },
              mutatorEdit: function(value, data, type, params, component){
                  // mets à jour le "selected"
                  data.Select.forEach(opt => opt.selected = (opt.version === value));
                  return data.Select;
              }
          },
          {
              title: "À ajouter (si nécessaire)",
              field: "Checkbox",
              formatter: function(cell){
                  let rowData = cell.getRow().getData();
                  let checked = rowData.Checkbox.some(opt => opt.checked);
                  return checked ? "✔" : "";
              },
              editor: true,
              cellEdited: function(cell){
                  let rowData = cell.getRow().getData();
                  let newVal = !rowData.Checkbox.some(opt => opt.checked);
                  rowData.Checkbox.forEach(opt => opt.checked = newVal);
                  cell.getTable().updateData([rowData]);
              }
          }
      ]
  });
</script>