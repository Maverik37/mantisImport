<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/css/tabulator.min.css">
<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>

<div id="modal_liste_lots" style="height:320px;"></div>

<script>
const lotsData = [
  {
    Name: "Abonnement Données SME",
    Select: [
      { id: 3245, version: "11.0.0", selected: false },
      { id: 7248, version: "12.0.0", selected: false },
      { id: 7249, version: "12.1.0", selected: false },
      { id: 8346, version: "13.0.0", selected: true }
    ]
  },
  {
    Name: "Autre Lot",
    Select: [
      { id: 9001, version: "1.0.0", selected: false },
      { id: 9002, version: "1.1.0", selected: false }
    ]
  }
];

// On ajoute un champ `selectedId` pour gérer la valeur du select
const dataWithSelectedId = lotsData.map(r => ({
  ...r,
  selectedId: (r.Select.find(o => o.selected) || {}).id ?? null
}));

new Tabulator("#modal_liste_lots", {
  data: dataWithSelectedId,
  layout: "fitColumns",
  columns: [
    { title: "Lot", field: "Name" },

    {
      title: "Version",
      field: "selectedId",
      editor: "list",
      editorParams: function(cell){
        const row = cell.getRow().getData();

        // on prépare les options + un placeholder
        const options = [
          { label: "-- Choisir une version --", value: null },
          ...row.Select.map(o => ({ label: o.version, value: o.id }))
        ];

        return {
          values: options,
          defaultValue: cell.getValue() ?? null
        };
      },
      formatter: function(cell){
        const row = cell.getRow().getData();
        const choice = row.Select.find(o => o.id === cell.getValue());
        return choice ? choice.version : "<span style='color:#aaa'>-- Choisir une version --</span>";
      },
      cellEdited: function(cell){
        const row = cell.getRow().getData();
        const chosenId = cell.getValue();

        // synchroniser le tableau Select
        row.Select.forEach(o => (o.selected = (o.id === chosenId)));
      }
    }
  ]
});
</script>