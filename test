from django.db.models import Count, Case, When, IntegerField
from django.db.models.functions import TruncMonth

def get_stats_par_mois():
    qs = (
        MaTable.objects
        .annotate(mois=TruncMonth("date"))
        .values("mois")
        .annotate(
            termines=Count(Case(When(statut="termine", then=1), output_field=IntegerField())),
            echecs=Count(Case(When(statut="echec", then=1), output_field=IntegerField())),
            abandonnes=Count(Case(When(statut="abandonne", then=1), output_field=IntegerField())),
        )
        .order_by("mois")
    )

    # Transformation en dict { "YYYY-MM": { "termine": X, "echec": Y, "abandonne": Z } }
    result = {
        item["mois"].strftime("%Y-%m"): {
            "termine": item["termines"],
            "echec": item["echecs"],
            "abandonne": item["abandonnes"],
        }
        for item in qs
    }
    return result